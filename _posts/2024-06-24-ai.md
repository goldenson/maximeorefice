---
layout: post
title: "ðŸ¤– AI"
date: 2024-06-24
image: "/assets/images/posts/ai.jpg"
---

![ai](/assets/images/posts/ai.jpg)

## Hackathon

This week I have been playing around with AI models from [Anthropic](https://www.anthropic.com/news/claude-3-5-sonnet) and [Vertex AI](https://cloud.google.com/vertex-ai/generative-ai/docs/learn/models) at GitLab to familiarize myself with this new technology.

I have learned a lot of new skills and discovered how powerful those recents models are.

## Detecting duplicate content

We have been working on a [small project](https://gitlab.com/gitlab-org/gitlab/-/issues/468157) in order to identify when an issue contains the same information.

The idea was to convert the content of an issue an generating an [embedding](https://cloud.google.com/vertex-ai/generative-ai/docs/embeddings/get-text-embeddings) for it.

This technique is being called [Semantic Similarity](https://en.wikipedia.org/wiki/Semantic_similarity).

> An embedding is a dense vector representation of discrete in a lower-dimensional space that captures semantic relationships and similarities commonly used in machine learning.

### How we did it?

*Note: The code is available [here](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/156761).*

First we installed [pgvector](https://github.com/pgvector/pgvector), a new postgres extension in order to store those records in our database:


```shell
$ brew install pgvector
```

```sql
CREATE EXTENSION vector;
```

Then we added a new column to persist those records in the issue table:

```sql
ALTER TABLE issues ADD COLUMN embedding vector(768);
```

And a new index to speed up the queries:

```sql
CREATE INDEX ON issues USING hnsw (embedding vector_l2_ops);
```

Finally we ran a script to import all existing issues for a given team and generating embedding for it.

To determine how similar an issue is with another one we leveraged the [neighboor gem](https://github.com/ankane/neighbor) to measure the euclidean distance between those vectors:

```ruby
nearest_issue = issue.nearest_neighbors(:embedding, distance: "euclidean").first
nearest_issue.neighbor_distance
=> 0.6025755637811935
```

This gives us a great approximation of how similar an issue with the rest of them and we need to adjust the distance to determine good threshold with our entire dataset.

For our use case, a distance of [0.3](https://gitlab.com/gitlab-org/gitlab/-/issues/468157#note_1957869527) gave us a good approximation of what we wanted to achieve.

### Links

- [Semantic Similarity](https://en.wikipedia.org/wiki/Semantic_similarity)
- [pgvector](https://www.timescale.com/learn/postgresql-extensions-pgvector)
- [Detect duplicate issues](https://mikulskibartosz.name/text-search-and-duplicate-detection-with-word-embeddings-and-vector-databases)
- [upgrade gdk](https://gitlab.com/gitlab-org/gitlab-development-kit/-/merge_requests/3778)
- [neighboor](https://github.com/ankane/neighbor)
